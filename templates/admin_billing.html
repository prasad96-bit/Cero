<h2>Admin - Billing Management</h2>

<div class="alert alert-info">
    Admin billing interface. All changes are logged in the audit trail.
</div>

<h3>Search Accounts</h3>
<form method="GET" action="/admin/billing">
    <div class="form-group">
        <label for="search">Search by Account Name or Email</label>
        <input type="text" id="search" name="q" placeholder="Enter account name or user email" autofocus>
    </div>
    <div class="form-group">
        <button type="submit" class="button">Search</button>
    </div>
</form>

{{#if_search_results}}
<h3 style="margin-top: 2rem;">Search Results</h3>
<table>
    <thead>
        <tr>
            <th>Account ID</th>
            <th>Account Name</th>
            <th>Plan</th>
            <th>Status</th>
            <th>Valid Until</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {{#each_account}}
        <tr>
            <td>{{account_id}}</td>
            <td>{{account_name}}</td>
            <td>{{plan}}</td>
            <td>{{status}}</td>
            <td>{{valid_until}}</td>
            <td>
                <a href="/admin/billing/edit?account_id={{account_id}}" class="button button-secondary">
                    Manage
                </a>
            </td>
        </tr>
        {{/each_account}}
    </tbody>
</table>
{{/if_search_results}}

{{#if_editing_account}}
<h3 style="margin-top: 2rem;">Manage Subscription: {{account_name}}</h3>

<h4>Current Subscription</h4>
<table>
    <tr>
        <th>Plan</th>
        <td>{{current_plan}}</td>
    </tr>
    <tr>
        <th>Status</th>
        <td>{{current_status}}</td>
    </tr>
    <tr>
        <th>Valid Until</th>
        <td>{{current_valid_until}}</td>
    </tr>
</table>

<h4 style="margin-top: 1.5rem;">Mark Payment as Received</h4>
<form method="POST" action="/admin/billing/mark-paid">
    <input type="hidden" name="csrf_token" value="{{csrf_token}}">
    <input type="hidden" name="account_id" value="{{account_id}}">

    <div class="form-group">
        <label for="plan">New Plan</label>
        <select id="plan" name="plan" required>
            <option value="free">Free</option>
            <option value="pro" selected>Pro</option>
            <option value="enterprise">Enterprise</option>
        </select>
    </div>

    <div class="form-group">
        <label for="duration_days">Duration (days)</label>
        <input type="number" id="duration_days" name="duration_days" value="30" min="1" required>
        <small style="color: #7f8c8d;">Common: 30 (monthly), 365 (yearly)</small>
    </div>

    <div class="form-group">
        <label for="amount_cents">Amount (cents)</label>
        <input type="number" id="amount_cents" name="amount_cents" value="4900" min="0" required>
        <small style="color: #7f8c8d;">Example: 4900 = $49.00</small>
    </div>

    <div class="form-group">
        <label for="payment_method">Payment Method</label>
        <select id="payment_method" name="payment_method" required>
            <option value="manual">Manual</option>
            <option value="bank_transfer">Bank Transfer</option>
            <option value="check">Check</option>
            <option value="payment_link">Payment Link</option>
            <option value="other">Other</option>
        </select>
    </div>

    <div class="form-group">
        <label for="external_reference">External Reference (Invoice #, Receipt #, etc.)</label>
        <input type="text" id="external_reference" name="external_reference" placeholder="e.g., INV-2026-001">
    </div>

    <div class="form-group">
        <label for="notes">Admin Notes</label>
        <textarea id="notes" name="notes" rows="3" placeholder="Optional notes about this payment..."></textarea>
    </div>

    <div class="form-group">
        <button type="submit" class="button">Mark as Paid & Update Subscription</button>
        <a href="/admin/billing" class="button button-secondary">Cancel</a>
    </div>
</form>

<h4 style="margin-top: 2rem;">Billing Event History</h4>
<table>
    <thead>
        <tr>
            <th>Date</th>
            <th>Event</th>
            <th>From → To</th>
            <th>Amount</th>
            <th>Reference</th>
            <th>Admin</th>
            <th>Notes</th>
        </tr>
    </thead>
    <tbody>
        {{#each_billing_event}}
        <tr>
            <td>{{occurred_at}}</td>
            <td>{{event_type}}</td>
            <td>{{previous_plan}} → {{new_plan}}</td>
            <td>{{amount}}</td>
            <td>{{external_reference}}</td>
            <td>{{admin_email}}</td>
            <td>{{notes}}</td>
        </tr>
        {{/each_billing_event}}
        {{#if_no_events}}
        <tr>
            <td colspan="7" style="text-align: center; color: #7f8c8d;">
                No billing events recorded
            </td>
        </tr>
        {{/if_no_events}}
    </tbody>
</table>
{{/if_editing_account}}

<div style="margin-top: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: 4px;">
    <h3>Admin Workflow</h3>
    <ol style="margin-left: 2rem;">
        <li>Customer emails payment confirmation</li>
        <li>Admin searches for customer account</li>
        <li>Admin verifies payment externally (bank statement, receipt, etc.)</li>
        <li>Admin marks payment as received in this interface</li>
        <li>System updates subscription and logs event</li>
        <li>Customer gets immediate access</li>
    </ol>
    <p style="margin-top: 1rem; color: #7f8c8d;">
        <em>All billing actions are logged to the immutable billing_events table
        and audit_log. This provides a complete financial audit trail.</em>
    </p>
</div>
